# 可视化监控面板 - 执行计划

## 任务概述

为 Jieba 分词服务添加系统性能监控面板，支持查看历史请求统计和图表展示。

## 技术方案

- **方案选择**：持久化监控面板（方案2）
- **前端技术**：Flask Jinja2 模板 + Chart.js
- **数据存储**：SQLite 数据库
- **集成方式**：集成到现有 Flask 应用

## 实施步骤

### 1. 数据库模型（models.py）
- 创建 `request_log` 表
- 字段：id, timestamp, endpoint, method, status_code, response_time, mode, text_length
- 实现数据库初始化和 CRUD 函数

### 2. 请求统计中间件（app.py）
- 修改 `log_request_info` 装饰器
- 在请求完成后自动记录到数据库
- 捕获分词模式和文本长度

### 3. 监控面板路由（app.py）
- `/dashboard` - 监控面板页面
- `/api/stats` - 统计数据 API
- 集成缓存统计信息

### 4. 前端模板（templates/dashboard.html）
- 统计卡片：总请求数、平均响应时间、缓存命中率、缓存大小
- 请求趋势图（折线图，最近24小时）
- 分词模式分布图（饼图）
- 最近请求记录表（最新50条）

### 5. 配置更新
- config.py：添加 DB_PATH 配置
- requirements.txt：添加 pytest-cov

## 监控指标

- **总请求数**：所有 API 请求总数
- **平均响应时间**：所有请求的平均处理时间
- **缓存命中率**：内存缓存的命中率百分比
- **请求趋势**：按小时统计的请求数量
- **模式分布**：各分词模式的使用占比
- **请求记录**：详细的请求日志（时间、端点、状态码、响应时间等）

## 访问方式

- **监控面板**：http://localhost:5000/dashboard
- **统计 API**：http://localhost:5000/api/stats
- **主页**：http://localhost:5000/

## 文件清单

**新建文件**：
- `models.py` - 数据库模型和操作函数
- `templates/dashboard.html` - 监控面板前端页面

**修改文件**：
- `app.py` - 添加数据库集成、路由和中间件
- `config.py` - 添加数据库配置
- `requirements.txt` - 添加测试覆盖率依赖
- `.gitignore` - 忽略数据库文件

## 测试结果

✅ 数据库初始化成功
✅ 请求自动记录到数据库
✅ 监控面板正常显示
✅ 统计 API 返回正确数据
✅ 图表正常渲染
✅ 实时数据更新

## 使用说明

1. 启动服务：`python app.py`
2. 访问监控面板：http://localhost:5000/dashboard
3. 调用分词 API 生成数据
4. 刷新面板查看实时统计

## 数据持久化

- 数据库文件：`jieba_stats.db`（SQLite）
- 自动创建，无需手动初始化
- 重启服务后数据保留
